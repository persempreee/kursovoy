= Требования к отечественному микроконтроллеру

== Основание для требований к микроконтроллерам

Современные измерительные приборы, используемые в промышленности предъявляют ряд специфических требований
к микроконтроллерам, для удовлетворения большинству применений.

Условно измерительные устройства можно разбить на несколько подгрупп:

* Датчики давления (наиболее обширный класс полевых устройств)
* Датчики температуры
* Датчики расхода
* Датчики уровня

Быстродействие::
Современные датчики очень требовательны к быстродействию, в зависимости от подгруппы в той
или иной степени, но в общем, чем быстрее микроконтроллер, тем лучше

Потребление::
Хотя все больше и больше измерительных устройств используют цифровые протоколы для настройки и мониторинга
измерительных параметров, большинство промышленных и полевых устройств все еще используют токовую петлю, как
универсальный способ управления системой и одновременно подачи питания на датчик.
В связи с этим одним предъявляются особые требования к потреблению, для обеспечения работоспособности на токе
ниже 3.2 мА и напряжении 10 Вольт

Себестоимость::
Рынок датчиков очень конкурентный, поэтому чем меньше себестоимость тем лучше, в том числе на это влияет и
цена микроконтроллера.

Исходя из вышесказанного очень грубо датчики можно разделить на две категории:

* Датчики с токовой петлей (давления, температуры, расхода, уровня и т.д.), требовательные к потреблению и
не имеющие сложных вычислений и не требовательные к большому размеру ОЗУ и ПЗУ.
* Датчики с цифровым протоколом выходом (давления, температуры, расхода, уровня и т.д.) не требовательные к
потреблению и имеющие довольно сложные вычисления

=== Датчики с токовой петлей (давления, температуры, расхода, уровня и т.д.)
Наиболее широко-распространённые полевые устройства. Обычно такой датчик состоит из сенсора, АЦП, ЦАП, NV памяти для
хранения настроек, индикатор, цифровой протокол для настройки (обычно HART, накладывающийся на токовую петлю).

[horizontal]
Объем рынка России:: оценивается в *100 000 -  150 000* приборов каждый год:

Для поддержки этой переферии, необходимо, чтобы микропроцессор имел следующую периферию:

* 2-3 SPI модуля для связи с АЦП, NV памяти, драйвером индикатора
* 1-2 UART модуля для поддержки и реализации цифрового интерфейса
* 3-4 Таймера для реализации канального уровня цифрового интерфейса, операционной системы реального времени
* 32 порта общего пользования
* Внешний источник тактовой частоты

Большинство полевых датчиков давления работают на токовой петле 4-20 мА, отсюда основное требование к
микроконтроллеру - потребление. Из-за потребления частота работы микроконтроллера может составлять
500 кГц. Поэтому для расчётов и обеспечение 25-30 обновлений измеряемой величины также необходимо и
соответствующее быстродействие:

* Потребление < 1мА на 1 Мгц
* Блок работы с плавающей точкой

Для поддержки алгоритмов диагностики и фильтрации сигнала:

* Блок работы с плавающей точкой
* DSP команды

Небольшой размер ОЗУ и ПЗУ, необходимый для большинства функций:

* 64 - 256 кБ ПЗУ
* 16 - 64 кБ ОЗУ

Цена микроконтроллераЖ

* 5$ штучно
* 3$ в партиях от 1000 штук
* 2$ в партиях от 10 000 штук
* 1-1.5$ в партиях от 50 000 штук

<<<
Ниже приведена таблица для характеристик универсального микроконтроллера, подходящего для большинства применений.
Аналогом такого микроконтроллера можно считать микроконтроллер STM32F411/413 фирмы ST.

[#Таблица 1]
.Сводная таблица с функциональностью "универсального микроконтроллера", покрывающего ~75% потребностей всех датчиков с аналоговой петлей.
[options="header"]
[cols="2,2,7,7a"]
|======
|Блок     |Наличие |Комментарий | Цена
|SPI      | 3      | Синхронный последовательный интерфейс для связи с EEPROM, LCD driver,
                     Сигма-Дельта АЦП .10+.^|
                     * 5$ штучно
                     * 3$ в партиях от 1000 штук
                     * 2$ в партиях от 10 000 штук
                     * 1-1.5$ в партиях от 50 000 штук
|UART     | 2      | Асинхронный последовательный интерфейс для реализации протокола настройки и
                     связи с платами расширения
|FPU      | Да     | Аппаратный блок с плавающей точкой, для быстрого выполнения расчётов с
                     плавающей точкой
|DSP      | Да     | Блок команд для цифровой фильтрации и быстрой обработки сигналов
|Timer    | 4      | Таймеры сблоками Сapture Сompare для реализации канального уровня протоколов
                     настройки, измрений частоты импульсов и так далее
|GPIO     | 32     | Порты общего назначения
|HSE      | 1      | Внешний источник тактирования
|Temp     | 1      | Датчик темпертуры, для измерения температуры платы и коррекции температурной
                     ошибки
|12bit ADC| 1      | 12 битный АЦП последоватльного приближения для диагностики петли и так далее..
                     (2 канала)
|RAM      | 32кБ   |
|ROM      | 128 кБ |
|======

<<<
Для того, чтобы заменить большинство зарубежных микросхем, можно внедрить в микроконтроллер дополнительную периферию,
такую как сигма-дельта АЦП, ЦАП, микросхема физического уровня HART.

[#Таблица 2]
.Сводная таблица с функциональностью "расширенного микроконтроллера", покрывающего ~95% потребностей всех датчиков с аналоговой петлей.
[options="header"]
[cols="2,2,7,7a"]
|======
|Блок     |Наличие |Комментарий | Цена
|SPI      | 3      | Синхронный последовательный интерфейс для связи с EEPROM, LCD driver,
                     Сигма-Дельта АЦП  .13+.^|
                                            * 25$ штучно
                                            * 15$ в партиях от 1000 штук
                                            * 8-10$ в партиях от 10 000 штук
                                            * 7-8$ в партиях от 50 000 штук
|UART     | 2      | Асинхронный последовательный интерфейс для реализации протокола настройки и связи с платами расширения
|FPU      | Да     | Аппаратный блок с плавающей точкой, для быстрого выполнения расчётов с плавающей точкой
|DSP      | Да     | Блок команд для цифровой фильтрации и быстрой обработки сигналов
|Timer    | 4      | Таймеры с блоками Сapture Сompare для реализации канального уровня протоколов настройки, измерений
                     частоты импульсов и так далее
|GPIO     | 32     | Порты общего назначения
|HSE      | 1      | Внешний источник тестирования
|Temp     | 1      | Датчик темпертуры, для измерения температуры платы и коррекции температурной ошибки
|24bit ADC| 1      | 24 битный Сигма Дельта АЦП 2 канальный для измерения основных величин и температуры микроконтроллера
|24bit DAC| 1      | 24 битный ЦАП для формирования токовой петли
|HART modem| 1     | Микросхема реализующая физический уровень BEL202 поверх токовой петли для формирования HART сигнала
|CAN       | 1     | Модуль CAN интерфейса
|RAM      | 64кБ   |
|ROM      | 256 кБ |
|======

<<<
=== Сравнение предложения на рынке
Из всего выше сказанного, на рынке существует единственный микроконтроллер боле менее удовлетворяющий требованиям из
<<Таблица 1>> - это микроконтроллер фирмы Миландр Серии 1986VE92

[#Таблица 3]
.Сравнение микроконтроллера необходимого для рынка и Миландр Серии 1986VE92
[options="header"]
[cols="2,2a, 2a, 2a"]
|======
|Блок |" Микроконтроллер универсальный"        | Миландр серии 1986VE92 | STM32L431
|SPI  |   [green]#&#10004;# 3                  | [red]#&#10060;# 1       | 3  [green]#&#10004;#
|I2C  |    0                                   | [green]#&#10004;# 1     | 3  [green]#&#10004;#
|UART |    [green]#&#10004;# 2                  | [red]#&#10060;# 1       | 4  [green]#&#10004;#
|FPU  |    [green]#&#10004;# Да                 | [red]#&#10060;# Нет     | Да [green]#&#10004;#
|DSP  |    [green]#&#10004;# Да                 | [green]#&#10004;# Да    | Да [green]#&#10004;#
|Timer|    [green]#&#10004;# 4                  | [green]#&#10004;# 1+3   | 11  [green]#&#10004;#
|GPIO |    [green]#&#10004;# 32                 | [green]#&#10004;# 96    | 83 [green]#&#10004;#
|HSE  |    [green]#&#10004;# Да                 | [green]#&#10004;# Да    | Да [green]#&#10004;#
|Temp |    [green]#&#10004;# Да                 | [green]#&#10004;# Да    | Да [green]#&#10004;#
|12bit ADC| [green]#&#10004;# Да  2 канала      | [green]#&#10004;# Да  16 каналов | Да [green]#&#10004;# 16 каналов
|RAM|   [green]#&#10004;# 32кБ                  | [green]#&#10004;# 32кБ | [green]#&#10004;# 64кБ
|ROM|   [green]#&#10004;# 128кБ                 | [green]#&#10004;# 32кБ | [green]#&#10004;# 256кБ
|Потребление| [green]#&#10004;# меньше 1 мА на 1 Мгц в активном режиме вся периферия включена  | [red]#&#10060;# больше 1mA на 1 Мгц | [green]#&#10004;# 600uA
|Цена, партия 100 штук| [green]#&#10004;# 3$| [red]#&#10060;# 7$ | [green]#&#10004;# 3$

|======

<<<
=== Предложение
* Разработать отечественный микроконтроллер с необходимыми характеристиками на открытом, нелицензируемой архитектуре
RISC-V для широкого круга датчиков.

RISC-V архитектура имеет ряд преимуществ::
* Простой и небольшой набор команд
* Открытая и свободная система команд
* Простая реализация ядра, уже есть ядра отечественных компаний, например Синтакор (Syntacore), Клаудбеар (CloudBEAR)
* Поддержка основных компиляторов С/C++ IAR, GCC
* Отсутствие зависимости от лицензиара



